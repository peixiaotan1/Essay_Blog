<%- include("partials/header.ejs") %>

<section>
    <form action=<%= "/edit/"+postId%> method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="postTitle">Title:</label>
            <input type="text" class="form-control" id="postTitle" name="postTitle"  value="<%= post.title %>" required>
        </div>

        <div class="form-group">
            <label for="postAuthor">Author:</label>
            <input type="text" class="form-control" id="postAuthor" name="postAuthor" value="<%= post.author || '' %>" required>
        </div>

        <div class="form-group">
            <label for="postImages">Images (optional):</label>
            <% if (post.imagePaths && post.imagePaths.length > 0) { %>
                <div class="current-images mb-3">
                    <h6>Current images:</h6>
                    <div class="home-images-gallery">
                        <% post.imagePaths.forEach(function(imagePath, index) { %>
                            <div class="current-image-item">
                                <img src="<%= imagePath.replace(/ /g, '%20') %>" alt="Current image <%= index + 1 %>" class="home-gallery-image">
                                <div class="image-number"><%= index + 1 %></div>
                                <button type="button" class="delete-image-btn" onclick="deleteImage(<%= post.id %>, '<%= imagePath %>', <%= index %>)" title="Delete this image">
                                    Ã—
                                </button>
                            </div>
                        <% }); %>
                    </div>
                </div>
            <% } %>
            <input type="file" class="form-control" id="postImages" name="postImages" accept="image/*" multiple>
            <small class="form-text text-muted">Supported formats: JPG, PNG, GIF. Max size: 5MB per file. You can select multiple images (up to 10). Leave empty to keep current images.</small>
        </div>

        <div class="form-group">
            <label for="postContent">Content:</label>
            <textarea class="form-control" id="postContent" name="postContent" rows="8" required><%= post.content %></textarea>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary">Update</button>
        </div>
    </form>
    
    <form action="/delete/<%= post.id %>" method="post" onsubmit="return confirm('Are you sure you want to delete this post?');">
        <div class="text-center" style="margin-top:20px;">
            <button type="submit" class="btn btn-danger">Delete</button>
        </div>
    </form>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("postTitle").focus();
    });

    function deleteImage(postId, imagePath, imageIndex) {
        if (confirm('Are you sure you want to delete this image?')) {
            fetch(`/delete-image/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    imagePath: imagePath,
                    imageIndex: imageIndex
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the image element from the page
                    const imageItem = document.querySelector(`[onclick*="${imagePath}"]`).closest('.current-image-item');
                    imageItem.remove();
                    
                    // Update image numbers
                    updateImageNumbers();
                    
                    // Show success message
                    alert('Image deleted successfully!');
                } else {
                    alert('Error deleting image: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting image');
            });
        }
    }

    function updateImageNumbers() {
        const imageItems = document.querySelectorAll('.current-image-item');
        imageItems.forEach((item, index) => {
            const numberDiv = item.querySelector('.image-number');
            if (numberDiv) {
                numberDiv.textContent = index + 1;
            }
        });
    }
</script>

<%- include("partials/footer.ejs") %>
